import React, { useEffect, useState } from "react";
import {
  Table,
  Button,
  Badge,
  Dropdown,
  Row,
  Col,
  Card,
  OverlayTrigger,
  Tooltip,
} from "react-bootstrap";
import { useNavigate } from "react-router-dom";
import { useSelector } from "react-redux";
import { toast } from "react-toastify";
import { getAllOrders, updateOrderStatus } from "../../api/orderApi";
import { updatePayment } from "../../api/paymentApi";
import "../Layout.scss";
import Loading from "../../components/Loading/Loading";

const statusMap = {
  pending: { label: "Ch·ªù x·ª≠ l√Ω", variant: "warning" },
  confirmed: { label: "ƒê√£ x√°c nh·∫≠n", variant: "info" },
  processing: { label: "ƒêang x·ª≠ l√Ω", variant: "primary" },
  shipped: { label: "ƒêang giao", variant: "primary" },
  delivered: { label: "ƒê√£ giao", variant: "success" },
  cancelled: { label: "ƒê√£ h·ªßy", variant: "danger" },
};

const paymentStatusMap = {
  unpaid: { label: "Ch∆∞a thanh to√°n", variant: "secondary" },
  paid: { label: "ƒê√£ thanh to√°n", variant: "success" },
  refunded: { label: "Ho√†n ti·ªÅn", variant: "info" },
};

const returnStatusMap = {
  none: { label: "Kh√¥ng tr·∫£", variant: "secondary" },
  requested: { label: "ƒê√£ y√™u c·∫ßu", variant: "warning" },
  approved: { label: "ƒê∆∞·ª£c duy·ªát", variant: "success" },
  rejected: { label: "B·ªã t·ª´ ch·ªëi", variant: "danger" },
  completed: { label: "Ho√†n t·∫•t", variant: "primary" },
};

const StatusBadge = ({ map, status }) => {
  const info = map[status] || { label: status, variant: "secondary" };
  return <Badge bg={info.variant}>{info.label}</Badge>;
};

const OrderManage = () => {
  const navigate = useNavigate();
  const user = useSelector((state) => state.user.user);
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(true);
  const [loadingId, setLoadingId] = useState(null);

  const fetchOrders = async () => {
    try {
      setLoading(true);
      const res = await getAllOrders();
      if (res?.errCode === 0) setOrders(res.data);
      else toast.error(res?.errMessage);
    } catch (err) {
      console.error(err);
      toast.error("L·ªói t·∫£i danh s√°ch ƒë∆°n h√†ng");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchOrders();
  }, []);

  const handleUpdateStatus = async (orderId, status) => {
    try {
      setLoadingId(orderId);
      const res = await updateOrderStatus(orderId, status);
      if (res?.errCode === 0)
        toast.success(`C·∫≠p nh·∫≠t: ${statusMap[status]?.label}`);
      else toast.error(res?.errMessage);
      await fetchOrders();
    } catch (err) {
      console.error(err);
      toast.error("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i");
    } finally {
      setLoadingId(null);
    }
  };

  const handleUpdatePaymentStatus = async (order, status) => {
    if (!user || user.role !== "admin") {
      toast.warning("B·∫°n kh√¥ng c√≥ quy·ªÅn c·∫≠p nh·∫≠t thanh to√°n!");
      return;
    }

    if (order.paymentMethod?.toLowerCase() !== "cod") {
      toast.info("Ch·ªâ ƒë∆°n h√†ng COD m·ªõi ƒë∆∞·ª£c c·∫≠p nh·∫≠t th·ªß c√¥ng!");
      return;
    }

    try {
      setLoadingId(order.id);
      const res = await updatePayment(order.id, { paymentStatus: status });
      if (res?.errCode === 0) {
        toast.success(`Thanh to√°n: ${paymentStatusMap[status]?.label}`);
        setOrders((prev) =>
          prev.map((o) =>
            o.id === order.id
              ? {
                  ...o,
                  payment: res.data,
                  paymentStatus:
                    res.data.status === "completed"
                      ? "paid"
                      : res.data.status === "refunded"
                      ? "refunded"
                      : "unpaid",
                }
              : o
          )
        );
        await fetchOrders();
      } else toast.error(res?.errMessage);
    } catch (err) {
      console.error(err);
      toast.error("L·ªói c·∫≠p nh·∫≠t thanh to√°n");
    } finally {
      setLoadingId(null);
    }
  };

  const formatCurrency = (v) =>
    v ? Number(v).toLocaleString("vi-VN") + " ‚Ç´" : "0 ‚Ç´";
  const formatDate = (d) => (d ? new Date(d).toLocaleDateString("vi-VN") : "‚Äî");

  const paidMethods = ["momo", "paypal", "vnpay", "bank", "transfer"];

  return (
    <>
      {loading && <Loading />}
      <div>
        <h3 className="mb-4">üì¶ Qu·∫£n l√Ω ƒë∆°n h√†ng</h3>
        <Card className="shadow-sm">
          <Card.Body>
            <Row className="mb-3">
              <Col md={4}>
                <h5>T·ªïng ƒë∆°n h√†ng: {orders.length}</h5>
              </Col>
            </Row>
            <Table
              striped
              bordered
              hover
              responsive
              className="align-middle text-center"
            >
              <thead className="table-light">
                <tr>
                  <th>M√£ ƒë∆°n</th>
                  <th className="text-start">Kh√°ch h√†ng</th>
                  <th>Ng√†y ƒë·∫∑t</th>
                  <th>T·ªïng ti·ªÅn</th>
                  <th>Ph∆∞∆°ng th·ª©c TT</th>
                  <th>Tr·∫°ng th√°i ƒë∆°n</th>
                  <th>Thanh to√°n</th>
                  <th>ƒê·ªãa ch·ªâ giao h√†ng</th>
                  <th>S·∫£n ph·∫©m</th>
                  <th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody>
                {orders.length === 0 && (
                  <tr>
                    <td colSpan="10" className="text-center text-muted py-4">
                      Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o.
                    </td>
                  </tr>
                )}
                {orders.map((order) => (
                  <tr key={order.id}>
                    <td>{`DH${order.id}`}</td>
                    <td className="text-start">{order.user?.username}</td>
                    <td>{formatDate(order.createdAt)}</td>
                    <td>{formatCurrency(order.totalPrice)}</td>
                    <td>{order.paymentMethod?.toUpperCase() || "‚Äî"}</td>
                    <td>
                      <StatusBadge map={statusMap} status={order.status} />
                    </td>
                    <td>
                      {paidMethods.includes(
                        order.paymentMethod?.toLowerCase()
                      ) ? (
                        <Badge bg="success">ƒê√£ thanh to√°n</Badge>
                      ) : order.payment ? (
                        <StatusBadge
                          map={paymentStatusMap}
                          status={order.paymentStatus || "unpaid"}
                        />
                      ) : (
                        <Badge bg="secondary">Ch∆∞a thanh to√°n</Badge>
                      )}
                    </td>
                    <td className="text-start">
                      <OverlayTrigger
                        placement="top"
                        overlay={<Tooltip>{order.shippingAddress}</Tooltip>}
                      >
                        <div
                          style={{
                            whiteSpace: "nowrap",
                            overflow: "hidden",
                            textOverflow: "ellipsis",
                            maxWidth: "200px",
                          }}
                        >
                          {order.shippingAddress || "‚Äî"}
                        </div>
                      </OverlayTrigger>
                    </td>
                    <td className="text-start">
                      {order.orderItems
                        ?.filter((item) => item.returnStatus !== "none")
                        .map((item) => (
                          <div key={item.id} className="mb-2">
                            <div>
                              <strong>Tr·∫°ng th√°i tr·∫£ h√†ng: </strong>
                              <StatusBadge
                                map={returnStatusMap}
                                status={item.returnStatus}
                              />
                            </div>
                            <div>
                              <strong>T√™n s·∫£n ph·∫©m:</strong> {item.productName}
                            </div>
                            <div>
                              <strong>S·ªë l∆∞·ª£ng:</strong> {item.quantity}
                            </div>
                            <div
                              style={{
                                whiteSpace: "nowrap",
                                overflow: "hidden",
                                textOverflow: "ellipsis",
                                maxWidth: "220px",
                              }}
                              title={item.returnReason}
                            >
                              <strong>L√Ω do:</strong> {item.returnReason}
                            </div>
                          </div>
                        ))}
                    </td>
                    <td>
                      <div className="d-flex justify-content-center flex-wrap gap-1">
                        <Dropdown>
                          <Dropdown.Toggle
                            variant="outline-primary"
                            size="sm"
                            disabled={loadingId === order.id}
                          >
                            C·∫≠p nh·∫≠t ƒë∆°n
                          </Dropdown.Toggle>
                          <Dropdown.Menu>
                            {Object.keys(statusMap).map((key) => (
                              <Dropdown.Item
                                key={key}
                                onClick={() =>
                                  handleUpdateStatus(order.id, key)
                                }
                                className={
                                  key === "cancelled" ? "text-danger" : ""
                                }
                              >
                                {statusMap[key].label}
                              </Dropdown.Item>
                            ))}
                          </Dropdown.Menu>
                        </Dropdown>

                        {user?.role === "admin" &&
                          order.paymentMethod?.toLowerCase() === "cod" && (
                            <Dropdown>
                              <Dropdown.Toggle
                                variant="outline-success"
                                size="sm"
                                disabled={loadingId === order.id}
                              >
                                C·∫≠p nh·∫≠t TT (COD)
                              </Dropdown.Toggle>
                              <Dropdown.Menu>
                                {Object.keys(paymentStatusMap).map((key) => (
                                  <Dropdown.Item
                                    key={key}
                                    onClick={() =>
                                      handleUpdatePaymentStatus(order, key)
                                    }
                                  >
                                    {paymentStatusMap[key].label}
                                  </Dropdown.Item>
                                ))}
                              </Dropdown.Menu>
                            </Dropdown>
                          )}

                        <Button
                          variant="outline-secondary"
                          size="sm"
                          disabled={loadingId === order.id}
                          onClick={() => navigate(`/orders-detail/${order.id}`)}
                        >
                          Chi ti·∫øt
                        </Button>

                        {order.orderItems?.some(
                          (item) => item.returnStatus === "requested"
                        ) && (
                          <Button
                            size="sm"
                            variant="danger"
                            onClick={() =>
                              navigate(`/admin/orders-return/${order.id}`)
                            }
                          >
                            Qu·∫£n l√Ω tr·∫£ h√†ng
                          </Button>
                        )}
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </Table>
          </Card.Body>
        </Card>
      </div>
    </>
  );
};

export default OrderManage;
